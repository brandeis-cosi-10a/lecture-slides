let problems = {
  "PS0": {
    "Hello World": {
      "Using IDE": false
    }
  },
  "PS1": {
    "Mad Libs": {
      "Variables": false,
      "Expressions": false,
      "input()": false
    },
    "Weight Comparisons": {
      "Variables": false,
      "Datatypes": false,
      "Expressions": false,
      "input()": false
    },
    "Interest Calculator": {
      "Variables": false,
      "Datatypes": false,
      "Expressions": false,
      "input()": false
    },
    "String escaping puzzle": {
      "String escaping": false
    }
  },
  "PS2": {
    "Light wavelength analyzer": {
      "Variables": false,
      "Expressions": false,
      "Conditionals": false,
      "Conditional logic": false,
      "Using IDE": false
    },
    "Choose your own adventure": {
      "Variables": false,
      "input()": false,
      "Conditionals": false,
      "Conditional logic": false
    },
    "Dice game: debugging": {
      "Variables": false,
      "Datatypes": false,
      "Expressions": false,
      "Conditionals": false,
      "Debugging": false,
      "Using pre-existing code": false
    }
  },
  "PS3": {
    "Tip Calculator": {
      "Variables": false,
      "Datatypes": false,
      "Expressions": false,
      "input()": false,
      "Conditionals": false,
      "Conditional logic": false
    },
    "Old lady": {
      "Function invocation": false,
      "Function definition": false,
      "Function parameters": false,
      "Functional Decomposition": false
    },
    "Dice Game Refactored": {
      "Function invocation": false,
      "Function definition": false,
      "Function parameters": false,
      "Globals": false
    },
    "Drawing Squares": {
      "Function invocation": false,
      "Function parameters": false
    },
    "Dice Game Refactored: Using pre": {
      "Using pre-existing code": false
    }
  },
  "PS4": {
    "Number guessing": {
      "Variables": false
    },
    "Number Guessing": {
      "Datatypes": false,
      "input()": false,
      "Conditionals": false,
      "Loops - while": false,
      "Loops - choosing structure": false
    },
    "Multiplication Tables": {
      "Expressions": false,
      "String escaping": false,
      "Function definition": false,
      "Function returns": false,
      "Fencepost algorithm": false,
      "Loops - nested": false,
      "Unit Testing": false
    },
    "Calendar Assistant": {
      "input()": false,
      "String escaping": false,
      "Conditionals": false,
      "Conditional logic": false,
      "Function invocation": false,
      "Function definition": false,
      "Function parameters": false,
      "Function returns": false,
      "Loops - for/range": false,
      "Cumulative algorithm": false,
      "Loops - choosing structure": false,
      "Unit Testing": false
    },
    "Dice Game Loops": {
      "Function invocation": false,
      "Function definition": false,
      "Function parameters": false,
      "Globals": false,
      "Loops - for/range": false,
      "Loops - choosing structure": false
    },
    "Dice Game Loops: Using pre": {
      "Using pre-existing code": false
    }
  },
  "PS5": {
    "To-do list": {
      "Variables": false,
      "input()": false,
      "String escaping": false,
      "Function invocation": false,
      "Function definition": false,
      "Function parameters": false,
      "Globals": false,
      "Loops - while": false,
      "Lists get/set": false,
      "List iteration": false,
      "Functional Decomposition": false
    },
    "Number filter": {
      "Datatypes": false,
      "input()": false,
      "Conditionals": false,
      "Loops - for/range": false,
      "Loops - while": false,
      "Cumulative algorithm": false,
      "Fencepost algorithm": false,
      "Loops - choosing structure": false,
      "Lists get/set": false,
      "List iteration": false
    },
    "Odd Calendar": {
      "Datatypes": false,
      "Expressions": false,
      "Conditionals": false,
      "Function definition": false,
      "Function returns": false,
      "Loops - for/range": false,
      "Cumulative algorithm": false,
      "Loops - choosing structure": false,
      "Lists get/set": false,
      "List iteration": false,
      "Unit Testing": false
    }
  },
  "PS6": {
    "Factor finder": {
      "Expressions": false,
      "Conditionals": false,
      "Function definition": false,
      "Function returns": false,
      "Loops - for/range": false,
      "Loops - nested": false,
      "Lists get/set": false,
      "List iteration": false,
      "Lists - nested": false
    },
    "Pig Latin": {
      "Expressions": false,
      "Conditionals": false,
      "Function invocation": false,
      "Function definition": false,
      "Function parameters": false,
      "Function returns": false,
      "Loops - for/range": false,
      "Cumulative algorithm": false,
      "Loops - choosing structure": false,
      "Lists get/set": false,
      "List iteration": false,
      "String manipulation": false,
      "Unit Testing": false,
      "Functional Decomposition": false
    },
    "Vowel Filter": {
      "Conditionals": false,
      "Conditional logic": false,
      "Function definition": false,
      "Function returns": false,
      "List iteration": false,
      "String manipulation": false,
      "Unit Testing": false
    }
  },
  "PS7": {
    "Dice Game Again": {
      "Variables": false,
      "input()": false,
      "Function invocation": false,
      "Function parameters": false,
      "Function returns": false,
      "Loops - while": false,
      "Lists get/set": false,
      "List iteration": false,
      "Tuples": false,
      "References": false,
      "Using pre-existing code": false
    },
    "Age range filter": {
      "Conditional logic": false,
      "Function definition": false,
      "Function returns": false,
      "Lists get/set": false,
      "Dictionary iteration": false,
      "Dictionary filtering": false,
      "Unit Testing": false
    },
    "Birthday Tracker": {
      "Function definition": false,
      "Function returns": false,
      "Cumulative algorithm": false,
      "Lists get/set": false,
      "List iteration": false,
      "Dictionaries get/set": false,
      "Dictionary iteration": false,
      "Sorting": false,
      "Nested data structures": false,
      "Unit Testing": false
    }
  },
  "PS8": {
    "Lottery Analyzer": {
      "Variables": false,
      "Expressions": false,
      "Conditionals": false,
      "Conditional logic": false,
      "Function invocation": false,
      "Function definition": false,
      "Function parameters": false,
      "Function returns": false,
      "Cumulative algorithm": false,
      "Loops - choosing structure": false,
      "Lists get/set": false,
      "List iteration": false,
      "Lists - nested": false,
      "String manipulation": false,
      "Tuples": false,
      "Dictionaries get/set": false,
      "Nested data structures": false,
      "File I/O": false,
      "File I/O - CSVs": false
    },
    "Contacts App": {
      "Datatypes": false,
      "String escaping": false,
      "Lists get/set": false,
      "List iteration": false,
      "Lists - nested": false,
      "References": false,
      "Dictionaries get/set": false,
      "Dictionary iteration": false,
      "Sorting": false,
      "Sets": false,
      "Nested data structures": false,
      "Data structures - choosing appropriately": false
    },
    "Word Analyzer": {
      "Function definition": false,
      "Function returns": false,
      "Loops - for/range": false,
      "Cumulative algorithm": false,
      "String manipulation": false,
      "Tuples": false,
      "Sets": false,
      "File I/O": false
    }
  },
  "PS9": {
    "Hiking Trails": {
      "Expressions": false,
      "Function parameters": false,
      "Fencepost algorithm": false,
      "Lists get/set": false,
      "List iteration": false,
      "Lists - nested": false,
      "Tuples": false,
      "Nested data structures": false,
      "Data structures - choosing appropriately": false,
      "Classes - definition": false,
      "Classes - usage": false,
      "Unit Testing": false
    },
    "Nobel Prizes": {
      "Conditionals": false,
      "Conditional logic": false,
      "Function definition": false,
      "Function returns": false,
      "Loops - for/range": false,
      "Cumulative algorithm": false,
      "Loops - nested": false,
      "List iteration": false,
      "Dictionaries get/set": false,
      "Dictionary iteration": false,
      "Dictionary filtering": false,
      "Sorting": false,
      "Sets": false,
      "Nested data structures": false,
      "File I/O": false,
      "File I/O - JSON": false,
      "Functional Decomposition": false,
      "Debugging": false
    },
    "Importing Contacts": {
      "Function definition": false,
      "References": false,
      "Dictionary iteration": false,
      "Sets": false,
      "Nested data structures": false,
      "Data structures - choosing appropriately": false,
      "File I/O": false,
      "File I/O - JSON": false,
      "Functional Decomposition": false,
      "Debugging": false,
      "Using pre-existing code": false
    }
  }
}

let skills = {
  "Using IDE": {
    "cap": 1,
    "count": 2
  },
  "Variables": {
    "cap": 4,
    "count": 11
  },
  "Datatypes": {
    "cap": 4,
    "count": 8
  },
  "Expressions": {
    "cap": 4,
    "count": 12
  },
  "input()": {
    "cap": 4,
    "count": 10
  },
  "String escaping": {
    "cap": 4,
    "count": 5
  },
  "Conditionals": {
    "cap": 4,
    "count": 13
  },
  "Conditional logic": {
    "cap": 4,
    "count": 8
  },
  "Function invocation": {
    "cap": 4,
    "count": 9
  },
  "Function definition": {
    "cap": 4,
    "count": 16
  },
  "Function parameters": {
    "cap": 4,
    "count": 10
  },
  "Function returns": {
    "cap": 4,
    "count": 12
  },
  "Globals": {
    "cap": 3,
    "count": 3
  },
  "Loops - for/range": {
    "cap": 4,
    "count": 8
  },
  "Loops - while": {
    "cap": 4,
    "count": 4
  },
  "Cumulative algorithm": {
    "cap": 4,
    "count": 8
  },
  "Fencepost algorithm": {
    "cap": 3,
    "count": 3
  },
  "Loops - nested": {
    "cap": 3,
    "count": 3
  },
  "Loops - choosing structure": {
    "cap": 4,
    "count": 7
  },
  "Lists get/set": {
    "cap": 4,
    "count": 11
  },
  "List iteration": {
    "cap": 4,
    "count": 12
  },
  "Lists - nested": {
    "cap": 4,
    "count": 4
  },
  "String manipulation": {
    "cap": 4,
    "count": 4
  },
  "Tuples": {
    "cap": 4,
    "count": 4
  },
  "References": {
    "cap": 3,
    "count": 3
  },
  "Dictionaries get/set": {
    "cap": 4,
    "count": 4
  },
  "Dictionary iteration": {
    "cap": 4,
    "count": 5
  },
  "Dictionary filtering": {
    "cap": 2,
    "count": 2
  },
  "Sorting": {
    "cap": 3,
    "count": 3
  },
  "Sets": {
    "cap": 4,
    "count": 4
  },
  "Nested data structures": {
    "cap": 4,
    "count": 6
  },
  "Data structures - choosing appropriately": {
    "cap": 3,
    "count": 3
  },
  "File I/O": {
    "cap": 4,
    "count": 4
  },
  "File I/O - CSVs": {
    "cap": 1,
    "count": 1
  },
  "File I/O - JSON": {
    "cap": 2,
    "count": 2
  },
  "Classes - definition": {
    "cap": 1,
    "count": 1
  },
  "Classes - usage": {
    "cap": 1,
    "count": 1
  },
  "Unit Testing": {
    "cap": 4,
    "count": 8
  },
  "Functional Decomposition": {
    "cap": 4,
    "count": 5
  },
  "Debugging": {
    "cap": 3,
    "count": 3
  },
  "Using pre-existing code": {
    "cap": 4,
    "count": 5
  }
}

function toggleProblem(skill, ps, problem) {
    // toggle the checkbox for this skill/problem
    setProblem(skill, ps, problem, !problems[ps][problem][skill]);
}

function setProblem(skill, ps, problem, value, up=true) {
    problems[ps][problem][skill] = value;
    document.getElementById(skill + "-" + problem + "-selected").checked = value;
    if(up) {
        update();
    }

}

function setSkill(skill, value) {
  for(const ps in problems) {
    for(const problemname in problems[ps]) {
      for(const skillname in problems[ps][problemname]) {
        setProblem(skillname, ps, problemname, value, false);
      }
    }
  }
  update();
}

function countPs() {
    let counts = {};
    for(const ps in problems) {
      for(const problemname in problems[ps]) {
        for(const skillname in problems[ps][problemname]) {
          counts[ps] = counts[ps] || {count: 0, total: 0};
          counts[problemname] = counts[problemname] || {count: 0, total: 0};

          counts[ps].total++;
          counts[problemname].total++;

          if(problems[ps][problemname][skillname]) {
            counts[ps].count++;
            counts[problemname].count++;
          }
        }
      }
    }
    return counts;
}

function setPs(ps, value) {
    for(const problemname in problems[ps]) {
      for(const skill in problems[ps][problemname]) {
        setProblem(skill, ps, problemname, value, false);
      }
    }
    update();
}

function resetEarnedCounts() {
  for(const skillname in skills) {
    skills[skillname].earned = 0;
  }
}

function update() {
    resetEarnedCounts();
    let total_earned_count = 0;
    let total_count = 0;

    for(const ps in problems) {
      for(const problemname in problems[ps]) {
        for(const skillname in problems[ps][problemname]) {
          if(problems[ps][problemname][skillname]) {
            skills[skillname].earned += 1;
            document.getElementById(skillname + "-" + problemname + "-selected").innerHTML = "yes";
          } else {
              document.getElementById(skillname + "-" + problemname + "-selected").innerHTML = "no";
          }
        }
      }
    }

    for(const skillname in skills) {
      console.log(skillname)
      const earned_count = skills[skillname]['earned'];
      const cap = skills[skillname]['cap'];
      total_count += skills[skillname]['cap'];
      const capped_count = earned_count > cap ? cap : earned_count;
      const skillElem = document.getElementById(skillname + "-total");
      skillElem.innerHTML = capped_count;
      total_earned_count += capped_count;
    }

    document.getElementById("earned-skills").innerHTML = total_earned_count;
    document.getElementById("possible-skills").innerHTML = total_count;
    document.getElementById("skills-percentage").innerHTML = (total_earned_count / total_count * 100).toFixed(2);
    let grade = "E";
    if(total_earned_count >= 135) {
        grade = "A+";
    } else if(total_earned_count >= 130) {
        grade = "A";
    } else if(total_earned_count >= 127) {
        grade = "A-";
    } else if(total_earned_count >= 123) {
        grade = "B+";
    } else if(total_earned_count >= 117) {
        grade = "B";
    } else if(total_earned_count >= 113) {
        grade = "B-";
    } else if(total_earned_count >= 109) {
        grade = "C+";
    } else if(total_earned_count >= 103) {
        grade = "C";
    } else if(total_earned_count >= 99) {
        grade = "C-";
    } else if(total_earned_count >= 94) {
        grade = "D+";
    } else if(total_earned_count >= 89) {
        grade = "D";
    } else if(total_earned_count >= 85) {
        grade = "D-";
    } else {
        grade = "E";
    }
    document.getElementById("grade").innerHTML = grade;

    const pscounts = countPs();
    for(const ps in pscounts) {
      document.getElementById(ps + "-earned").innerHTML = pscounts[ps].count;
      document.getElementById(ps + "-total").innerHTML = pscounts[ps].total
    }

    console.log(skills);
    localStorage.setItem("problems", JSON.stringify(problems));
}

(function() {
    if(localStorage.getItem("problems") !== null) {
        problems = JSON.parse(localStorage.getItem("problems"));
    }
    console.log(skills);
    const skillcontainer = document.getElementById("container");
    const skilltotal_container = document.getElementById("skilltotal-container")
    let ps = [];
    let psets = {};

    //for(const skillname in skills) {
    for(const pset in problems) {
        console.log(pset);
        let content = "<div class='row skill-heading'>" +
        "<div class='eight columns' style='padding-top:10px'><b>" + pset + "</b> (<span id='" + pset + "-earned'></span>/<span id='" + pset + "-total'></span>)</div>" +
        "<div class='four columns'>" +
          "<button class='toggle-btn' onclick='setPs(\"" + pset + "\", false)'>none</button>" +
          "<button class='toggle-btn' onclick='setPs(\"" + pset + "\", true)'>all</button>" +
        "</div>" +
//        "<div class='two columns'><button class='toggle-btn' onclick='setPs(\"" + pset + "\", false)'>none</button></div>" +
        "</div>";

        for(const problemname in problems[pset]) {
          content += "<div class='row'>" +
            "<div class='ten columns'><b>&nbsp;&nbsp;" + problemname + "</b> (<span id='" + problemname + "-earned'></span>/<span id='" + problemname + "-total'></span>)</div>" +
            "</div>";

          for(const skillname in problems[pset][problemname]) {
            const selected = problems[pset][problemname][skillname] ? "checked" : "";
            content += "<div class='row'>" +
              "<div class='ten columns'>&nbsp;&nbsp;&nbsp;&nbsp;" + skillname + "</div>" +
              "<div class='two columns'>" +
                  "<input type='checkbox' " + selected + " id='" + skillname + "-" + problemname + "-selected' onclick='toggleProblem(\"" + skillname + "\", \"" + pset + "\", \"" + problemname + "\")'>" +
              "</div>" +
              "</div>";
          }
        }
        /*
        */
        skillcontainer.insertAdjacentHTML('beforeend', content);
    }

    for(const skillname in skills) {
      console.log("init skillname", skillname);
      const cap = skills[skillname]['cap'];
      let content = "<div class='row'>" +
        "<div class='ten columns'>" + skillname + ": </div>" +
        "<div class='two columns'><b><span id='" + skillname + "-total'>" + 0 + "</span> / " + cap + "</b></div>" +
        "</div>";

        /*
        let content = "<div class='row'>" +
            "<div class='five columns' style='padding-top:10px'><b>" + p + "</b> (<span id='" + p + "-earned'></span>/<span id='" + p + "-total'></span>)</div>" +
            "<div class='seven columns'><button style='padding: 0px 10px 0px 10px' onclick='setPs(\"" + p + "\", true)'>all</button>" +
            "<button style='padding: 0px 10px 0px 10px' onclick='setPs(\"" + p + "\", false)'>none</button></div>" +
            "</div>";
            */
        skilltotal_container.insertAdjacentHTML( 'beforeend', content);
    }
    update();
})();